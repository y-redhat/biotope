<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Biotope ‚Äì Survival Stable Edition</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<style>
body{margin:0;background:#000;overflow:hidden;font-family:monospace}
#ui{position:absolute;bottom:6px;left:50%;transform:translateX(-50%);color:#0f0}
</style>
</head>
<body>
<div id="ui">
YEAR:<span id="year">0</span> |
POP:<span id="pop">0</span> |
FOOD:<span id="food">0</span>
</div>

<script>
/* ================= ‰∏ñÁïå ================= */
let organisms=[], foods=[];
let time=0, year=0;

/* ================= È£üÊñô ================= */
const FOOD_TYPES={
 plant:{heal:0.4,color:[80,255,120]},
 meat:{heal:0.7,color:[255,80,80]},
 omni:{heal:0.55,color:[200,200,120]}
};

/* ================= ÁîüÁâ© ================= */
class Organism{
 constructor(x,y,dna){
  this.pos=createVector(x,y);
  this.vel=p5.Vector.random2D();
  this.acc=createVector();
  this.age=0;
  this.maxAge=random(2500,3500);
  this.health=random(0.8,1);
  this.cooldown=0;

  this.dna=dna||{
   size:random(8,12),
   speed:random(1.2,2),
   sense:random(80,130),
   diet:random(["plant","meat","omni"]),
   fertility:random(0.6,1.4), // üß¨ ÁîüÊÆñÊ¨≤
   hue:random(360)
  };
 }

 update(){
  this.age++;
  this.cooldown=max(0,this.cooldown-1);

  /* üåé Ëá™ÁÑ∂Ê∑òÊ±∞ÔºàË∂ÖÂº±Ôºâ */
  this.health -= 0.00012 * pow(this.dna.size,0.5);

  this.forage();
  this.vel.add(this.acc);
  this.vel.limit(this.dna.speed);
  this.pos.add(this.vel);
  this.acc.mult(0);
  this.edges();
 }

 forage(){
  let best=null, d=this.dna.sense;
  for(let i=foods.length-1;i>=0;i--){
   let f=foods[i];
   let dista=p5.Vector.dist(this.pos,f.pos);
   if(dista<d){
    d=dista; best=f;
    if(dista<this.dna.size){
     foods.splice(i,1);
     let gain=FOOD_TYPES[f.type].heal;
     if(this.dna.diet==="omni") gain*=1.1;
     if(this.dna.diet!==f.type && f.type!=="omni") gain*=0.6;
     this.health=min(1,this.health+gain);
    }
   }
  }
  if(best) this.applyForce(p5.Vector.sub(best.pos,this.pos).setMag(0.2));
  else this.wander();
 }

 wander(){
  let a=noise(this.pos.x*0.01,this.pos.y*0.01,time*0.01)*TWO_PI*2;
  this.applyForce(p5.Vector.fromAngle(a).mult(0.15));
 }

 /* ü§ù Êé•Ëß¶ÁπÅÊÆñÔºàÂ§ßÈáèÔºâ */
 tryReproduce(other){
  if(this.cooldown>0||other.cooldown>0) return;
  if(this.health<0.55||other.health<0.55) return;

  let desire=(this.health+other.health)*this.dna.fertility;
  if(random()>0.08*desire) return;

  let babies=floor(random(1,3+this.dna.fertility));
  this.cooldown=200; other.cooldown=200;
  this.health-=0.1; other.health-=0.1;

  for(let i=0;i<babies;i++){
   organisms.push(new Organism(
    this.pos.x+random(-10,10),
    this.pos.y+random(-10,10),
    {
     size:this.dna.size+random(-0.5,0.5),
     speed:this.dna.speed+random(-0.15,0.15),
     sense:this.dna.sense+random(-10,10),
     diet:random([this.dna.diet,other.dna.diet,"omni"]),
     fertility:constrain(this.dna.fertility+random(-0.1,0.1),0.4,1.6),
     hue:(this.dna.hue+random(-8,8)+360)%360
    }
   ));
  }
 }

 applyForce(f){this.acc.add(f)}
 edges(){
  if(this.pos.x<0)this.pos.x=width;
  if(this.pos.x>width)this.pos.x=0;
  if(this.pos.y<0)this.pos.y=height;
  if(this.pos.y>height)this.pos.y=0;
 }
 dead(){return this.health<=0||this.age>this.maxAge}
 show(){
  colorMode(HSB,360,100,100,100);
  fill(this.dna.hue,80,100,90);
  noStroke();
  circle(this.pos.x,this.pos.y,this.dna.size*2);
  colorMode(RGB,255);
 }
}

/* ================= È£üÊñôÁîüÊàê ================= */
function spawnFood(){
 let t=random()<0.5?"plant":random()<0.7?"omni":"meat";
 foods.push({pos:createVector(random(width),random(height)),type:t});
}

/* ================= p5 ================= */
function setup(){
 createCanvas(windowWidth,windowHeight);
 for(let i=0;i<250;i++) spawnFood();
 for(let i=0;i<16;i++) organisms.push(new Organism(random(width),random(height)));
}

function draw(){
 time++; if(time%60===0) year++;
 background(0,25,15);

 document.getElementById("year").innerText=year;
 document.getElementById("pop").innerText=organisms.length;
 document.getElementById("food").innerText=foods.length;

 if(random()<0.45) spawnFood();

 for(let f of foods){
  let c=FOOD_TYPES[f.type].color;
  fill(c[0],c[1],c[2],150); noStroke();
  circle(f.pos.x,f.pos.y,5);
 }

 for(let i=organisms.length-1;i>=0;i--){
  let o=organisms[i];
  o.update(); o.show();
  for(let j=i-1;j>=0;j--){
   if(p5.Vector.dist(o.pos,organisms[j].pos)<o.dna.size*2){
    o.tryReproduce(organisms[j]);
   }
  }
  if(o.dead()) organisms.splice(i,1);
 }
}

function windowResized(){resizeCanvas(windowWidth,windowHeight)}
</script>
</body>
</html>
