<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>NovaNotions â€“ Ideology Biotope Stable</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<style>
body{margin:0;background:#000;font-family:monospace;overflow:hidden}
#ui{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);width:90%;text-align:center;z-index:10}
input{width:60%;padding:10px;background:rgba(0,0,0,.8);border:1px solid #0f0;color:#0f0}
#stats{color:#aaa;font-size:12px;margin-bottom:4px}
#log{position:absolute;top:10px;left:10px;width:420px;height:260px;overflow:auto;
font-size:11px;color:#0f0;background:rgba(0,0,0,.6);border:1px solid #033;padding:5px}
</style>
</head>

<body>
<div id="log"></div>
<div id="ui">
<div id="stats">
TIME:<span id="timer">00:00</span> |
YEAR:<span id="year">0</span> |
POP:<span id="pop">0</span> |
CIV:<span id="civ">Hunter-Gatherer</span> |
WAR:<span id="warstat">NO</span>
</div>
<input id="cmd" placeholder="> genesis / evolve / war / meteor / reset">
</div>

<script>
/* =====================
   ã‚°ãƒ­ãƒ¼ãƒãƒ«
===================== */
let organisms=[],foods=[],nations=[];
let time=0,epoch=0,war=false,civilization=0;
let fertility=1,startTime=0;
const CIV_NAMES=["Hunter-Gatherer","Agriculture","Nation"];
const MIN_RUN_MS=1000*60*5;
const PROTECTED_MS=1000*60*2;

/* è»½é‡åŒ–åˆ¶å¾¡ */
let updatePhase=0;
function phased(n){return frameCount%n===updatePhase}

/* ãƒ­ã‚°è»½é‡åŒ– */
let logBuffer=[];

/* é£Ÿæ–™å®šç¾© */
const FOOD_TYPES={
 plant:{color:[100,255,100],energy:0.25},
 meat:{color:[255,80,80],energy:0.6},
 farm:{color:[180,255,120],energy:0.4}
};

/* =====================
   åˆæœŸåŒ–
===================== */
function setup(){
 createCanvas(windowWidth,windowHeight);
 spawnFood(200);
 startTime=millis();
 runCommand("genesis");
 if(organisms[0]) organisms[0].protectedUntil=millis()+PROTECTED_MS;

 cmd.addEventListener("keydown",e=>{
  if(e.key==="Enter"){runCommand(cmd.value);cmd.value="";}
 });
}

/* =====================
   ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
===================== */
function draw(){
 time++; if(time%60===0) epoch++;
 updatePhase=(updatePhase+1)%4;

 background(0,30*fertility,10);

 let elapsed=millis()-startTime;
 timer.innerText=nf(floor(elapsed/60000),2)+":"+nf(floor(elapsed/1000)%60,2);

 if(organisms.length>40&&civilization===0) civilization=1;
 if(organisms.length>120&&civilization===1) civilization=2;

 year.innerText=epoch;
 pop.innerText=organisms.length;
 civ.innerText=CIV_NAMES[civilization];
 warstat.innerText=war?"YES":"NO";

 if(random()<0.12*fertility){
  let t="plant";
  if(civilization>=1&&random()<0.3) t="farm";
  foods.push({pos:createVector(random(width),random(height)),type:t});
 }

 noStroke();
 for(let f of foods){
  let c=FOOD_TYPES[f.type].color;
  fill(c[0],c[1],c[2],140);
  circle(f.pos.x,f.pos.y,4);
 }

 let red=0,blue=0;
 for(let i=organisms.length-1;i>=0;i--){
  let o=organisms[i];
  o.update();
  o.show();
  if(o.dead()){
   if(random()<0.5) foods.push({pos:o.pos.copy(),type:"meat"});
   organisms.splice(i,1);
   fertility=min(1,fertility+0.001);
  }else{
   o.ideology==="red"?red++:blue++;
  }
 }

 if(elapsed<MIN_RUN_MS) ensureMinPopulation(8);

 if(!war&&organisms.length>100&&elapsed>=MIN_RUN_MS) startWar();
 if(war){
  if(red<=10&&blue>10) endWar("red");
  if(blue<=10&&red>10) endWar("blue");
 }

 if(time%600===0&&organisms.length<100) formNations();
 if(time%180===0) nations.forEach(n=>nTick(n));

 if(organisms.length>160){
  organisms.length=160;
  log("âš  population capped");
 }

 if(frameCount%20===0){
  logDiv.innerHTML=logBuffer.slice().reverse().join("<br>");
 }
}

/* =====================
   ç”Ÿç‰©
===================== */
class Organism{
 constructor(x,y,dna){
  this.pos=createVector(x,y);
  this.vel=p5.Vector.random2D().mult(0.5);
  this.acc=createVector();

  this.ideology=random()<0.5?"red":"blue";
  this.pos.x=this.ideology==="red"?random(width*0.05,width*0.45):random(width*0.55,width*0.95);
  this.baseHue=this.ideology==="red"?0:220;
  this.ideologyStrength=random(0.35,1);

  this.dna=dna||{size:random(8,15),speed:random(0.6,1.2),sense:random(60,110)};
  this.diet=random(["herbivore","carnivore","omnivore"]);
  this.sex=random()<0.5?"M":"F";

  this.health=1;
  this.age=0;
  this.maxAge=random(4000,8000);

  this.matingCooldown=0;
  this.pregnant=false;
  this.gestation=0;
  this.gestationPeriod=floor(random(600,1200));

  this.stash=0;
  this.infected=false;
  this.virusLoad=0;
  this.immunity=random(0,0.6);

  this.protectedUntil=undefined;
 }

 update(){
  this.age++;
  this.health-=0.0005*pow(this.dna.size,0.6);

  if(this.infected&&phased(4)){
   this.health-=this.virusLoad*0.0007*(1-this.immunity*0.6);
   if(random()<0.001){
    this.virusLoad=max(0,this.virusLoad-0.05);
    if(this.virusLoad<0.05){this.infected=false;log("âœš recovered")}
   }
  }

  if(this.pregnant){
   this.gestation++;
   if(this.gestation>=this.gestationPeriod) this.giveBirth();
  }else if(this.matingCooldown<=0&&this.sex==="F"&&random()<0.002){
   this.seekMate();
  }else{
   this.forage();
  }

  this.vel.add(this.acc).limit(this.dna.speed*(war?1.2:1));
  this.pos.add(this.vel);
  this.acc.set(0,0);
  this.edges();

  if(phased(4)){
   for(let o of organisms){
    if(o!==this&&dist(this.pos.x,this.pos.y,o.pos.x,o.pos.y)<8){
     if(this.infected&&!o.infected&&random()<0.0008) o.infect(this.virusLoad*0.6);
    }
   }
  }

  if(this.protectedUntil&&millis()<this.protectedUntil){
   this.health=max(this.health,0.15);
   if(this.infected) this.virusLoad=max(0,this.virusLoad-0.02);
  }

  if(this.matingCooldown>0) this.matingCooldown--;
 }

 infect(l){this.infected=true;this.virusLoad=constrain(this.virusLoad+l,0,1)}

 forage(){
  let nearest=null,dmin=this.dna.sense;
  for(let i=foods.length-1;i>=0;i--){
   let d=p5.Vector.dist(this.pos,foods[i].pos);
   if(d<dmin){
    dmin=d;nearest=foods[i];
    if(d<this.dna.size){
     let gain=FOOD_TYPES[foods[i].type].energy;
     this.health+=gain;
     foods.splice(i,1);
    }
   }
  }
  if(nearest) this.acc.add(this.seek(nearest.pos));
 }

 seekMate(){
  let tries=0;
  for(let o of organisms){
   if(++tries>12) break;
   if(o!==this&&o.sex==="M"&&o.ideology===this.ideology){
    let d=dist(this.pos.x,this.pos.y,o.pos.x,o.pos.y);
    if(d<this.dna.size*1.5&&this.health>0.9){
     this.becomePregnant();
     o.matingCooldown=600;
     this.matingCooldown=600;
     break;
    }
   }
  }
 }

 becomePregnant(){
  this.pregnant=true;
  this.gestation=0;
  log("â™¥ pregnancy");
 }

 giveBirth(){
  this.pregnant=false;
  let child=new Organism(this.pos.x+random(-6,6),this.pos.y+random(-6,6));
  child.ideology=this.ideology;
  child.baseHue=this.baseHue;
  organisms.push(child);
  log("âœ³ birth");
 }

 dead(){
  if(this.protectedUntil&&millis()<this.protectedUntil) return false;
  return this.health<=0||this.age>this.maxAge;
 }

 seek(t){
  let d=p5.Vector.sub(t,this.pos);
  d.setMag(this.dna.speed);
  return p5.Vector.sub(d,this.vel).limit(0.12);
 }

 edges(){
  if(this.ideology==="red") this.pos.x=constrain(this.pos.x,0,width*0.55);
  else this.pos.x=constrain(this.pos.x,width*0.45,width);
  this.pos.y=constrain(this.pos.y,0,height);
 }

 show(){
  colorMode(HSB,360,100,100,100);
  fill(this.baseHue,this.ideologyStrength*100,90,95);
  noStroke();
  ellipse(this.pos.x,this.pos.y,this.dna.size*0.8);
  colorMode(RGB,255);
 }
}

/* =====================
   å›½å®¶ãƒ»æˆ¦äº‰
===================== */
function formNations(){}
function nTick(n){}

function startWar(){
 if(civilization<2) return;
 war=true; log("âš” WAR STARTED");
}
function endWar(l){
 war=false; log("ðŸ³ "+l+" surrendered");
}

/* =====================
   è£œåŠ©
===================== */
function spawnFood(n){
 for(let i=0;i<n;i++) foods.push({pos:createVector(random(width),random(height)),type:"plant"});
}
function log(t){
 logBuffer.push(t);
 if(logBuffer.length>40) logBuffer.shift();
}
function ensureMinPopulation(n){
 while(organisms.length<n) organisms.push(new Organism(random(width),random(height)));
}
function windowResized(){resizeCanvas(windowWidth,windowHeight)}
</script>
</body>
</html>
