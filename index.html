<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>NovaNotions â€“ Ideology Biotope Stable</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<style>
body{margin:0;background:#000;font-family:monospace;overflow:hidden}
#ui{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
width:90%;text-align:center;z-index:10}
input{width:60%;padding:10px;background:rgba(0,0,0,.8);
border:1px solid #0f0;color:#0f0}
#stats{color:#aaa;font-size:12px;margin-bottom:4px}
#log{position:absolute;top:10px;left:10px;width:420px;height:260px;
overflow:auto;font-size:11px;color:#0f0;
background:rgba(0,0,0,.6);border:1px solid #033;padding:5px}
</style>
</head>

<body>
<div id="log"></div>
<div id="ui">
<div id="stats">
TIME:<span id="timer">00:00</span> |
YEAR:<span id="year">0</span> |
POP:<span id="pop">0</span> |
CIV:<span id="civ">Hunter-Gatherer</span> |
WAR:<span id="warstat">NO</span>
</div>
<input id="cmd" placeholder="> genesis / war / reset">
</div>

<script>
/* =====================
   ã‚°ãƒ­ãƒ¼ãƒãƒ«
===================== */
let organisms=[],foods=[],nations=[];
let time=0,epoch=0,war=false,civilization=0;
let fertility=1,startTime=0;
const CIV_NAMES=["Hunter-Gatherer","Agriculture","Nation"];
let cmd,logDiv,logBuffer=[];

/* é£Ÿæ–™ */
const FOOD_TYPES={
 plant:{color:[100,255,100],energy:0.25},
 meat:{color:[255,80,80],energy:0.6},
 farm:{color:[180,255,120],energy:0.4}
};

/* =====================
   åˆæœŸåŒ–
===================== */
function setup(){
 createCanvas(windowWidth,windowHeight);
 cmd=document.getElementById("cmd");
 logDiv=document.getElementById("log");
 spawnFood(200);
 startTime=millis();
 runCommand("genesis");

 cmd.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
   runCommand(cmd.value);
   cmd.value="";
  }
 });
}

/* =====================
   ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
===================== */
function draw(){
 background(0,30,10);
 time++; if(time%60===0) epoch++;

 if(organisms.length>40&&civilization===0) civilization=1;
 if(organisms.length>120&&civilization===1) civilization=2;

 let elapsed=millis()-startTime;
 timer.innerText=
  nf(floor(elapsed/60000),2)+":"+nf(floor(elapsed/1000)%60,2);
 year.innerText=epoch;
 pop.innerText=organisms.length;
 civ.innerText=CIV_NAMES[civilization];
 warstat.innerText=war?"YES":"NO";

 if(random()<0.12*fertility){
  let t="plant";
  if(civilization>=1&&random()<0.3) t="farm";
  foods.push({pos:createVector(random(width),random(height)),type:t});
 }

 noStroke();
 for(let f of foods){
  let c=FOOD_TYPES[f.type].color;
  fill(c[0],c[1],c[2],140);
  circle(f.pos.x,f.pos.y,4);
 }

 let red=0,blue=0;
 for(let i=organisms.length-1;i>=0;i--){
  let o=organisms[i];
  o.update();
  o.show();
  if(o.dead()){
   if(random()<0.5)
    foods.push({pos:o.pos.copy(),type:"meat"});
   organisms.splice(i,1);
  }else{
   o.ideology==="red"?red++:blue++;
  }
 }

 if(!war&&organisms.length>100) startWar();
 if(war){
  if(red<10||blue<10) endWar();
 }

 if(frameCount%20===0)
  logDiv.innerHTML=logBuffer.slice().reverse().join("<br>");
}

/* =====================
   ç”Ÿç‰©
===================== */
class Organism{
 constructor(x,y){
  this.pos=createVector(x,y);
  this.vel=p5.Vector.random2D().mult(0.6);
  this.acc=createVector();
  this.ideology=random()<0.5?"red":"blue";
  this.baseHue=this.ideology==="red"?0:220;
  this.size=random(8,14);
  this.health=1;
  this.age=0;
  this.maxAge=random(4000,8000);
 }

 update(){
  this.age++;
  this.health-=0.0004;

  this.forage();
  if(war) this.acc.add(p5.Vector.random2D().mult(0.05));

  this.vel.add(this.acc).limit(1);
  this.pos.add(this.vel);
  this.acc.mult(0);
  this.edges();
 }

 forage(){
  let nearest=null,dmin=80;
  for(let i=foods.length-1;i>=0;i--){
   let d=p5.Vector.dist(this.pos,foods[i].pos);
   if(d<dmin){
    dmin=d;nearest=foods[i];
    if(d<this.size){
     this.health+=FOOD_TYPES[foods[i].type].energy;
     foods.splice(i,1);
    }
   }
  }
  if(nearest)
   this.acc.add(p5.Vector.sub(nearest.pos,this.pos)
    .setMag(0.05));
 }

 dead(){return this.health<=0||this.age>this.maxAge}

 edges(){
  if(this.ideology==="red")
   this.pos.x=constrain(this.pos.x,0,width*0.55);
  else
   this.pos.x=constrain(this.pos.x,width*0.45,width);
  this.pos.y=constrain(this.pos.y,0,height);
 }

 show(){
  colorMode(HSB,360,100,100);
  fill(this.baseHue,90,90);
  ellipse(this.pos.x,this.pos.y,this.size);
  colorMode(RGB,255);
 }
}

/* =====================
   å›½å®¶ãƒ»æˆ¦äº‰
===================== */
function startWar(){
 if(civilization<2) return;
 war=true;
 log("âš” WAR STARTED");
}
function endWar(){
 war=false;
 log("ðŸ³ WAR ENDED");
}

/* =====================
   ã‚³ãƒžãƒ³ãƒ‰
===================== */
function runCommand(c){
 c=c.trim();
 if(c==="genesis"){
  if(organisms.length===0){
   for(let i=0;i<16;i++)
    organisms.push(new Organism(random(width),random(height)));
   log("ðŸŒ± genesis");
  }
 }
 if(c==="war") startWar();
 if(c==="reset"){
  organisms=[];foods=[];nations=[];
  civilization=0;war=false;
  spawnFood(200);
  runCommand("genesis");
  log("â†º reset");
 }
}

/* =====================
   è£œåŠ©
===================== */
function spawnFood(n){
 for(let i=0;i<n;i++)
  foods.push({pos:createVector(random(width),random(height)),
              type:"plant"});
}
function log(t){
 logBuffer.push(t);
 if(logBuffer.length>40) logBuffer.shift();
}
function windowResized(){
 resizeCanvas(windowWidth,windowHeight);
}
</script>
</body>
</html>

