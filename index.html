<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>NovaNotions â€“ Ideology Civilization Biotope (æ”¹è‰¯ç‰ˆ)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<style>
body{margin:0;background:#000;font-family:monospace;overflow:hidden}
#ui{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);width:90%;text-align:center;z-index:10}
input{width:60%;padding:10px;background:rgba(0,0,0,.8);border:1px solid #0f0;color:#0f0}
#stats{color:#aaa;font-size:12px;margin-bottom:4px}
#log{position:absolute;top:10px;left:10px;width:360px;height:220px;overflow:auto;
font-size:11px;color:#0f0;background:rgba(0,0,0,.6);border:1px solid #033;padding:5px}
</style>
</head>

<body>
<div id="log"></div>
<div id="ui">
<div id="stats">
TIME:<span id="timer">00:00</span> |
YEAR:<span id="year">0</span> |
POP:<span id="pop">0</span> |
CIV:<span id="civ">Hunter-Gatherer</span> |
WAR:<span id="warstat">NO</span>
</div>
<input id="cmd" placeholder="> genesis / evolve / war / meteor / reset">
</div>

<script>
/* =====================
   ã‚°ãƒ­ãƒ¼ãƒãƒ«
===================== */
let organisms=[],foods=[],time=0,epoch=0;
let fertility=1,civilization=0,war=false;
const CIV_NAMES=["Hunter-Gatherer","Agriculture","Nation"];

const FOOD_TYPES={
 plant:{color:[100,255,100],energy:0.25},
 meat:{color:[255,80,80],energy:0.6},
 farm:{color:[180,255,120],energy:0.4}
};

/* æ€æƒ³ */
const IDEOLOGY={
 red:{name:"Communism",xMin:0},
 blue:{name:"Capitalism",xMin:0}
};

/* ç¨¼åƒæ™‚é–“åˆ¶å¾¡ */
let startTime=0;
const MIN_RUN_MS = 1000 * 60 * 5; // 5åˆ†

function setup(){
 createCanvas(windowWidth,windowHeight);
 spawnFood(200);
 runCommand("genesis");

 startTime = millis();

 cmd.addEventListener("keydown",e=>{
  if(e.key==="Enter"){runCommand(cmd.value);cmd.value="";}
 });
}

/* =====================
   ãƒ¡ã‚¤ãƒ³
===================== */
function draw(){
 time++; if(time%60===0) epoch++;
 background(0,30*fertility,10);

 // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºï¼ˆmm:ssï¼‰
 let elapsed = millis() - startTime;
 let s = floor(elapsed/1000);
 let mm = nf(floor(s/60),2);
 let ss = nf(s%60,2);
 timer.innerText = mm + ":" + ss;

 // æ–‡æ˜é€²åŒ–
 if(organisms.length>40 && civilization===0) civilization=1;
 if(organisms.length>120 && civilization===1) civilization=2;

 // UI
 year.innerText=epoch;
 pop.innerText=organisms.length;
 civ.innerText=CIV_NAMES[civilization];
 warstat.innerText=war?"YES":"NO";

 // é£Ÿæ–™ç”Ÿæˆï¼ˆæ–‡æ˜ã§ farm å‡ºç¾ç¢ºç‡å¤‰åŒ–ï¼‰
 if(random()<0.12*fertility){
  let type="plant";
  if(civilization>=1 && random()<0.3) type="farm";
  foods.push({pos:createVector(random(width),random(height)),type});
 }

 // é£Ÿæ–™æç”»
 noStroke();
 for(let f of foods){
  let c=FOOD_TYPES[f.type].color;
  fill(c[0],c[1],c[2],140);
  circle(f.pos.x,f.pos.y,4);
 }

 // å€‹ä½“æ›´æ–°
 let red=0,blue=0;
 for(let i=organisms.length-1;i>=0;i--){
  let o=organisms[i];
  o.update();
  o.show();
  if(o.dead()){
   if(random()<0.5) foods.push({pos:o.pos.copy(),type:"meat"});
   organisms.splice(i,1);
   fertility=min(1,fertility+0.001);
  }else{
   if(o.ideology==="red") red++; else blue++;
   let child=o.reproduce();
   if(child) organisms.push(child);
  }
 }

 // æœ€ä½5åˆ†é–“ã¯çµ¶æ»…ã‚’é˜²ãï¼ˆ5åˆ†æœªæº€ãªã‚‰å°‘æ•°è£œå……ï¼‰
 if(elapsed < MIN_RUN_MS){
  ensureMinPopulation(8);
 }

 // æˆ¦äº‰æ¡ä»¶ï¼ˆè‡ªå‹•ç™ºç”Ÿã¯5åˆ†å¾Œã‹ã‚‰ï¼‰
 if(!war && organisms.length>100 && elapsed>=MIN_RUN_MS) startWar();
 if(!war && organisms.length>100 && elapsed<MIN_RUN_MS){
  // 5åˆ†æœªæº€ã§æˆ¦äº‰æ¡ä»¶ã‚’æº€ãŸã—ã¦ã‚‚ãƒ­ã‚°ã ã‘å‡ºã™ï¼ˆå®Ÿè¡Œã¯ã—ãªã„ï¼‰
  // ä¸€åº¦ã ã‘é€šçŸ¥ã™ã‚‹ãŸã‚ã€time%300===0 ãªã©ã§æ–­ç¶šçš„ã«è¡¨ç¤º
  if(time % 300 === 0) log("War locked until 5 minutes have passed");
 }
 if(war){
  if(red<=10 && blue>10) endWar("red");
  if(blue<=10 && red>10) endWar("blue");
 }
}

/* =====================
   ã‚³ãƒãƒ³ãƒ‰
===================== */
function runCommand(cmd){
 cmd=cmd.toLowerCase().trim();
 let elapsed = millis()-startTime;
 if(cmd==="genesis"){
  for(let i=0;i<10;i++){
   organisms.push(new Organism(random(width),random(height)));
  }
  log("> genesis");
 }
 else if(cmd==="evolve"){
  organisms.forEach(o=>{
   o.dna.speed=constrain(o.dna.speed+random(-0.3,0.3),0.5,3);
  });
  log("> evolve");
 }
 else if(cmd==="meteor"){
  if(elapsed < MIN_RUN_MS){
   log("â˜„ METEOR LOCKED: simulation protected for 5 minutes");
   return;
  }
  organisms=organisms.slice(0,floor(organisms.length/2));
  fertility=0.2;
  log("â˜„ METEOR IMPACT");
 }
 else if(cmd==="war"){
  if(elapsed < MIN_RUN_MS){
   log("âš  War command locked until 5 minutes have passed");
   return;
  }
  startWar();
 }
 else if(cmd==="reset") location.reload();
}

/* =====================
   ç”Ÿç‰©
===================== */
class Organism{
 constructor(x,y,dna){
  this.pos=createVector(x,y);
  this.vel=p5.Vector.random2D();
  this.acc=createVector();

  this.ideology=random()<0.5?"red":"blue";
  if(this.ideology==="red") this.pos.x=random(width/2);
  else this.pos.x=random(width/2,width);

  this.dna=dna||{
   size:random(8,15),
   speed:random(0.6,1.4),
   sense:random(50,90),
   hue:random(360)
  };

  this.diet=random(["herbivore","carnivore","omnivore"]);
  this.memory={good:0,bad:0};

  this.health=1;
  this.age=0;
  this.maxAge=random(900,1400);

  // è³‡æœ¬ä¸»ç¾©ç”¨ã®è²¯è“„ï¼ˆstashï¼‰ã‚„å…±ç”£ä¸»ç¾©ç”¨ã®å”åŠ›ãƒ•ãƒ©ã‚°
  this.stash = 0; // blue ãŒè“„ãˆã‚‹
  this.coopCooldown = 0; // red ã®å…±æœ‰ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³åˆ¶å¾¡
 }

 update(){
  this.age++;
  if(this.health<=0||this.age>this.maxAge) this.health=0;

  // æ–‡æ˜ãŒé€²ã‚€ã¨ä¸­å¿ƒã«é›†ã¾ã‚‹å‚¾å‘ï¼ˆæ—¢å­˜ï¼‰
  if(civilization===2){
   let cx=this.ideology==="red"?width*0.25:width*0.75;
   this.applyForce(this.seek(createVector(cx,height/2)).mult(0.2));
  }else this.forage();

  // è¿½åŠ ï¼šæ€æƒ³ã”ã¨ã®è¡Œå‹•æ€§å·®
  if(this.ideology==="blue"){
   // è³‡æœ¬ä¸»ç¾©: ã‚ˆã‚Šç²å¾—åŠ¹ç‡ã‚’è¿½æ±‚ã™ã‚‹ -> å°‘ã—é€Ÿããªã‚‹ãŒç–²å¼Šã‚‚
   this.vel.limit(this.dna.speed * (war?1.45:1.15));
  }else{
   // å…±ç”£ä¸»ç¾©: å”åŠ›çš„ãªã®ã§å®‰å®šã—ãŸé€Ÿåº¦
   this.vel.limit(this.dna.speed * (war?1.2:1));
  }

  this.vel.add(this.acc);
  this.pos.add(this.vel);
  this.acc.mult(0);

  // åŸºæœ¬ã®æ¶ˆè€—
  this.health-=0.002*pow(this.dna.size,0.75);
  this.edges();

  // æˆ¦äº‰æ™‚ã®æ”»æ’ƒåˆ¤å®šï¼ˆæ€æƒ³ã«ã‚ˆã‚Šè‡´æ­»ç‡ã‚’å¤‰ãˆã‚‹ï¼‰
  if(war){
   for(let o of organisms){
    if(o!==this && o.ideology!==this.ideology && dist(this.pos.x,this.pos.y,o.pos.x,o.pos.y)<6){
     let killProb = (this.ideology==="blue") ? 0.02 : 0.006; // blueãŒæ”»æ’ƒçš„
     if(random()<killProb) o.health = max(0, o.health - random(0.6,1.0));
     // å…±ç”£ä¸»ç¾©ã¯ä»²é–“ãŒã‚„ã‚‰ã‚Œãã†ã ã¨æ´è­·ã™ã‚‹ï¼ˆè¿‘ãã®redãŒå°å›å¾©ã‚’ä¸ãˆã‚‹ï¼‰
     if(this.ideology==="red"){
      this.callForAid();
     }
    }
   }
  }

  // å…±ç”£ä¸»ç¾©: ä»²é–“æ”¯æ´ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³å‡¦ç†
  if(this.coopCooldown>0) this.coopCooldown--;

  // è³‡æœ¬ä¸»ç¾©: stash ã‚’å°‘ã—è‡ªç„¶æ¶ˆè²»ï¼ˆå–å¼•ã‚„å†æŠ•è³‡ï¼‰
  if(this.stash>0) this.stash = max(0, this.stash - 0.0005);
 }

 forage(){
  let nearest=null,dmin=this.dna.sense;
  for(let i=foods.length-1;i>=0;i--){
   let d=p5.Vector.dist(this.pos,foods[i].pos);
   // è³‡æœ¬ä¸»ç¾©ã¯ farm ã‚’å„ªå…ˆçš„ã«æ¢ã™ï¼ˆfarm ã«å¼•ãå¯„ã›ï¼‰
   let score = d;
   if(this.ideology==="blue" && foods[i].type==="farm") score *= 0.6;
   if(score<dmin){
    dmin=score; nearest=foods[i];
    // å–å¾—å‡¦ç†ï¼ˆã‚µã‚¤ã‚ºä»¥å†…ï¼‰
    if(dist(this.pos.x,this.pos.y,foods[i].pos.x,foods[i].pos.y) < this.dna.size){
     let gain = FOOD_TYPES[foods[i].type].energy;
     if(this.diet==="herbivore"&&foods[i].type==="meat") gain*=0.2;
     if(this.diet==="carnivore"&&foods[i].type!=="meat") gain*=0.2;

     // æ€æƒ³ã”ã¨ã®æ‘‚å–çµæœ
     if(this.ideology==="red"){
      // å…±ç”£ä¸»ç¾©: å¤šãã¯ä»²é–“ã«å†åˆ†é…ã™ã‚‹ãŸã‚ã«ä¸€éƒ¨ã‚’å¤–éƒ¨ã¸é‚„å…ƒ
      let selfGain = gain * 0.8;
      let share = gain * 0.2;
      this.health += selfGain;
      this.memory.good++;
      // è¿‘ãã§å¼±ã„èµ¤ã«é…ã‚‹
      if(this.coopCooldown===0){
       this.shareToAllies(share);
       this.coopCooldown = 180; // ç´„3ç§’ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
      }
     }else{
      // è³‡æœ¬ä¸»ç¾©: ä¸€éƒ¨ã‚’stashï¼ˆè“„è²¡ï¼‰ã—ã¦ã€ä½“åŠ›ã«å›ã™ã®ã¯ä¸€éƒ¨ã ã‘
      let toStash = gain * 0.6;
      let selfGain = gain * 0.4;
      this.stash += toStash;
      this.health += selfGain;
      this.memory.good++;
     }

     foods.splice(i,1);
    }
   }
  }
  if(nearest) this.applyForce(this.seek(nearest.pos));
  else this.wander();
 }

 // å…±ç”£ä¸»ç¾©: è¿‘ãã®å¼±ã„ä»²é–“ã«å°‘é‡ã®å¥åº·ã‚’åˆ†ã‘ã‚‹
 shareToAllies(amount){
  let given = 0;
  for(let o of organisms){
   if(o!==this && o.ideology==="red"){
    let d = dist(this.pos.x,this.pos.y,o.pos.x,o.pos.y);
    if(d < 60 && o.health < 0.9){
     let take = min(amount*0.4, 0.25 - o.health);
     if(take>0){
      o.health += take;
      given += take;
     }
    }
   }
  }
  // è‡ªåˆ†ã®healthã‹ã‚‰å°‘ã—æ¸›ã‚‰ã™ï¼ˆåˆ†é…ã‚³ã‚¹ãƒˆï¼‰
  this.health = max(0, this.health - given*0.6);
  if(given>0) log("âœ¦ red redistributed energy");
 }

 // å…±ç”£ä¸»ç¾©: ä»²é–“ãŒã‚„ã‚‰ã‚Œãã†ãªã¨ãæ´è­·ï¼ˆå°å›å¾©ï¼‰ã‚’å‘¼ã¶
 callForAid(){
  for(let o of organisms){
   if(o!==this && o.ideology==="red"){
    let d = dist(this.pos.x,this.pos.y,o.pos.x,o.pos.y);
    if(d < 80 && o.health < 0.6){
     o.health = min(1.2, o.health + 0.08);
    }
  }
  }
 }

 wander(){
  let a=noise(this.pos.x*0.01,this.pos.y*0.01,time*0.01)*TWO_PI*2;
  this.applyForce(p5.Vector.fromAngle(a).mult(0.08));
 }

 reproduce(){
  // å…±ç”£ä¸»ç¾©: å¥åº·ãŒååˆ†ã«é«˜ã‘ã‚Œã°è‡ªç„¶åˆ†è£‚çš„ã«å¢—ãˆã‚‹ãŒç¢ºç‡ã¯æ§ãˆã‚
  if(this.ideology==="red"){
   if(this.health>1.1 && random()<0.0035){
    this.health/=2;
    let childDNA={
     size:this.dna.size+random(-1,1),
     speed:this.dna.speed+random(-0.2,0.2),
     sense:this.dna.sense+random(-10,10) + this.memory.good*0.3 - this.memory.bad*0.2,
     hue:(this.dna.hue+random(-10,10)+360)%360
    };
    log("Birth (red) + Mutation");
    return new Organism(this.pos.x,this.pos.y,childDNA);
   }
  }else{
   // è³‡æœ¬ä¸»ç¾©: stash ã‚’ãŸã‚ã¦å†ç”Ÿç”£ï¼ˆæŠ•è³‡çš„è¤‡è£½ï¼‰
   if(this.stash > 0.6 && random()<0.01){
    this.stash *= 0.4; // æŠ•è³‡ã—ã¦æ¶ˆè²»
    let childDNA={
     size:this.dna.size+random(-1,1),
     speed:this.dna.speed+random(-0.2,0.2),
     sense:this.dna.sense+random(-10,10) + this.memory.good*0.5 - this.memory.bad*0.1,
     hue:(this.dna.hue+random(-10,10)+360)%360
    };
    log("Birth (blue) - funded by stash");
    return new Organism(this.pos.x,this.pos.y,childDNA);
   }
  }
  return null;
 }

 dead(){return this.health<=0;}

 seek(t){
  let d=p5.Vector.sub(t,this.pos);
  d.setMag(this.dna.speed);
  return p5.Vector.sub(d,this.vel).limit(0.1);
 }

 applyForce(f){this.acc.add(f);}
 edges(){
  if(this.ideology==="red") this.pos.x=constrain(this.pos.x,0,width/2);
  else this.pos.x=constrain(this.pos.x,width/2,width);
  this.pos.y=constrain(this.pos.y,0,height);
 }
 show(){
  colorMode(HSB,360,100,100,100);
  fill(this.dna.hue,80,100,80);
  noStroke();
  ellipse(this.pos.x,this.pos.y,this.dna.size*0.7);
  // stash ã‚’å°ã•ãªå††ã§è¡¨ç¤ºï¼ˆblueã®ã¿ï¼‰
  if(this.ideology==="blue" && this.stash>0.02){
   fill(200,80,90,80);
   circle(this.pos.x,this.pos.y - this.dna.size, map(this.stash,0,2,2,8));
  }
  colorMode(RGB,255);
 }
}

/* =====================
   æˆ¦äº‰
===================== */
function startWar(){
 if(civilization<2) {
  log("War cannot start until civilization reaches Nation");
  return;
 }
 war=true;
 log("âš” WAR STARTED");
}
function endWar(loser){
 war=false;
 log("ğŸ³ "+loser+" surrendered");
}

/* =====================
   è£œåŠ©
===================== */
function spawnFood(n){
 for(let i=0;i<n;i++)
  foods.push({pos:createVector(random(width),random(height)),type:"plant"});
}
function log(t){
 let l=document.getElementById("log");
 l.innerHTML=t+"<br>"+l.innerHTML;
}
function windowResized(){resizeCanvas(windowWidth,windowHeight);}

// æœ€ä½äººå£ã‚’ä¿ã¤ï¼ˆåˆæœŸ5åˆ†é–“ã®ä¿è­·ï¼‰
function ensureMinPopulation(minCount){
 if(organisms.length >= minCount) return;
 let need = minCount - organisms.length;
 for(let i=0;i<need;i++){
  let a = new Organism(random(width),random(height));
  // ãªã‚‹ã¹ãæ€æƒ³ãƒãƒ©ãƒ³ã‚¹è‰¯ã
  a.ideology = (random()<0.5) ? "red" : "blue";
  organisms.push(a);
 }
 log("Population protected: spawned " + need + " individuals");
}
</script>
</body>
</html>
