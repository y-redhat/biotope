<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Biotope â€“ Learning Life Edition</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<style>
body{margin:0;background:#000;overflow:hidden;font-family:monospace}
#ui{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);color:#0f0}
</style>
</head>
<body>
<div id="ui">
YEAR:<span id="year">0</span> |
POP:<span id="pop">0</span> |
HOUSES:<span id="house">0</span>
</div>

<script>
/* ================= ä¸–ç•Œ ================= */
let organisms=[], foods=[], houses=[];
let time=0, year=0, civilization=0;

/* ================= ã‚¦ã‚¤ãƒ«ã‚¹ ================= */
const VIRUS_POOL=[
 {name:"Mild",infect:0.15,severity:0.08,death:0.001},
 {name:"Flu",infect:0.12,severity:0.15,death:0.003}
];
class Virus{
 constructor(t){Object.assign(this,t)}
 mutate(){
  this.infect=constrain(this.infect+random(-0.005,0.005),0.05,0.3);
  this.severity=constrain(this.severity+random(-0.01,0.01),0.05,0.4);
 }
}

/* ================= å®¶ ================= */
class House{
 constructor(x,y){this.pos=createVector(x,y);this.r=70}
 show(){noFill();stroke(200,200,50,70);circle(this.pos.x,this.pos.y,this.r*2)}
}

/* ================= ç”Ÿç‰© ================= */
class Organism{
 constructor(x,y,dna,brain){
  this.pos=createVector(x,y);
  this.vel=p5.Vector.random2D();
  this.acc=createVector();
  this.health=1; this.age=0;
  this.virus=null;
  this.dna=dna||{
    size:random(8,13),
    speed:random(1.2,2.2),
    sense:random(70,110),
    hue:random(360)
  };
  // ğŸ§  è¶…ç°¡æ˜“AIï¼ˆå­¦ç¿’ï¼‰
  this.brain=brain||{
    foodBias:createVector(random(-1,1),random(-1,1)), // é£Ÿæ–™æ–¹å‘ã®å¥½ã¿
    avoidBias:createVector(0,0) // å±é™ºå›é¿
  };
 }

 update(){
  this.age++;
  // ğŸ”½ è‡ªç„¶æ·˜æ±°å¼±ä½“åŒ–ï¼ˆåŸºç¤æ¶ˆè€—ï¼‰
  this.health -= 0.0004 * pow(this.dna.size,0.6);

  // ğŸ¦  ã‚¦ã‚¤ãƒ«ã‚¹
  if(this.virus){
   this.health -= this.virus.severity*0.0003;
   if(random()<0.001) this.virus.mutate();
   if(random()<0.0006) this.virus=null;
   this.spreadVirus();
  }

  this.learnAndMove();
  this.vel.add(this.acc);
  this.vel.limit(this.dna.speed);
  this.pos.add(this.vel);
  this.acc.mult(0);
  this.edges();
 }

 /* ===== å­¦ç¿’AI ===== */
 learnAndMove(){
  let target=null, d=this.dna.sense;
  for(let i=foods.length-1;i>=0;i--){
   let dista=p5.Vector.dist(this.pos,foods[i]);
   if(dista<d){
    d=dista; target=foods[i];
    if(dista<this.dna.size){
     foods.splice(i,1);
     this.health=min(1,this.health+0.7);
     // ğŸ‘ æˆåŠŸå­¦ç¿’
     let dir=p5.Vector.sub(target,this.pos).normalize();
     this.brain.foodBias.lerp(dir,0.2);
    }
   }
  }
  if(target){
   let desire=p5.Vector.sub(target,this.pos).normalize();
   desire.add(this.brain.foodBias).add(this.brain.avoidBias);
   this.applyForce(desire.mult(0.2));
  }else{
   this.wander();
  }
 }

 wander(){
  let a=noise(this.pos.x*0.01,this.pos.y*0.01,time*0.01)*TWO_PI*2;
  this.applyForce(p5.Vector.fromAngle(a).mult(0.15));
 }

 /* ===== æ¥è§¦ç¹æ®– ===== */
 tryReproduce(other){
  if(this.health<0.6||other.health<0.6) return null;
  if(random()<0.05){
   this.health-=0.08; other.health-=0.08;
   let h=new House((this.pos.x+other.pos.x)/2,(this.pos.y+other.pos.y)/2);
   houses.push(h);
   return new Organism(
    h.pos.x,h.pos.y,
    {
     size:this.dna.size+random(-0.8,0.8),
     speed:this.dna.speed+random(-0.2,0.2),
     sense:this.dna.sense+random(-8,8),
     hue:(this.dna.hue+random(-10,10)+360)%360
    },
    {
     foodBias:p5.Vector.lerp(this.brain.foodBias,other.brain.foodBias,0.5),
     avoidBias:createVector(0,0)
    }
   );
  }
  return null;
 }

 spreadVirus(){
  for(let o of organisms){
   if(!o.virus && o!==this){
    if(p5.Vector.dist(this.pos,o.pos)<this.dna.size*2 && random()<this.virus.infect){
     o.virus=new Virus(this.virus);
    }
   }
  }
 }

 applyForce(f){this.acc.add(f)}
 edges(){
  if(this.pos.x<0)this.pos.x=width;
  if(this.pos.x>width)this.pos.x=0;
  if(this.pos.y<0)this.pos.y=height;
  if(this.pos.y>height)this.pos.y=0;
 }
 dead(){return this.health<=0||this.age>1600}

 show(){
  colorMode(HSB,360,100,100,100);
  fill(this.dna.hue,80,this.virus?70:100,80);
  noStroke();
  circle(this.pos.x,this.pos.y,this.dna.size*2);
  colorMode(RGB,255);
 }
}

/* ================= p5 ================= */
function setup(){
 createCanvas(windowWidth,windowHeight);
 for(let i=0;i<150;i++) foods.push(createVector(random(width),random(height)));
 for(let i=0;i<12;i++) organisms.push(new Organism(random(width),random(height)));
}

function draw(){
 time++; if(time%60===0) year++;
 background(0,30,15);

 document.getElementById("year").innerText=year;
 document.getElementById("pop").innerText=organisms.length;
 document.getElementById("house").innerText=houses.length;

 if(random()<0.2) foods.push(createVector(random(width),random(height)));

 noStroke(); fill(100,255,100,120);
 foods.forEach(f=>circle(f.x,f.y,4));
 houses.forEach(h=>h.show());

 for(let i=organisms.length-1;i>=0;i--){
  let o=organisms[i];
  o.update(); o.show();

  // ğŸ¤ æ¥è§¦ï¼ç¹æ®–
  for(let j=i-1;j>=0;j--){
   let other=organisms[j];
   if(p5.Vector.dist(o.pos,other.pos)<o.dna.size*2){
    let child=o.tryReproduce(other);
    if(child) organisms.push(child);
   }
  }

  if(o.dead()) organisms.splice(i,1);
 }
}

function windowResized(){resizeCanvas(windowWidth,windowHeight)}
</script>
</body>
</html>
