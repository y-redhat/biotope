<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>NovaNotions Biotope – Civilization Edition</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>

<style>
body {
  margin:0;
  background:#000;
  overflow:hidden;
  font-family: monospace;
}
#ui {
  position:absolute;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  text-align:center;
  z-index:10;
}
input {
  width:60%;
  padding:10px;
  background:rgba(0,0,0,.8);
  border:1px solid #0f0;
  color:#0f0;
}
#stats {
  color:#aaa;
  font-size:12px;
  margin-bottom:4px;
}
#log {
  position:absolute;
  top:10px;
  left:10px;
  width:300px;
  height:200px;
  overflow:auto;
  font-size:11px;
  color:#0f0;
  background:rgba(0,0,0,.6);
  border:1px solid #033;
  padding:5px;
}
</style>
</head>

<body>
<div id="log"></div>

<div id="ui">
  <div id="stats">
    YEAR:<span id="year">0</span> |
    POP:<span id="pop">0</span> |
    CIV:<span id="civ">Hunter-Gatherer</span>
  </div>
  <input id="cmd" placeholder="> genesis / evolve / war / religion / meteor / reset">
</div>

<script>
/* =====================
   グローバル状態
===================== */
let organisms = [];
let foods = [];
let time = 0;
let epoch = 0;

let fertility = 1;
let civilization = 0; 
// 0:採集 1:農耕 2:国家

const CIV_NAMES = ["Hunter-Gatherer","Agriculture","Nation"];

function setup(){
  createCanvas(windowWidth,windowHeight);
  spawnFood(200);
  runCommand("genesis");

  const input=document.getElementById("cmd");
  input.focus();
  input.addEventListener("keydown",e=>{
    if(e.key==="Enter"){
      runCommand(input.value);
      input.value="";
      input.focus();
    }
  });
}

function draw(){
  time++;
  if(time%60===0) epoch++;

  background(0,30*fertility,10);

  // 文明進化条件
  if(organisms.length>40 && civilization===0) civilization=1;
  if(organisms.length>120 && civilization===1) civilization=2;

  // UI更新
  year.innerText=epoch;
  pop.innerText=organisms.length;
  civ.innerText=CIV_NAMES[civilization];

  // 食料生成
  if(random()<0.15*fertility) foods.push(createVector(random(width),random(height)));

  // 食料描画
  fill(100,255,100,120);
  noStroke();
  for(let f of foods) circle(f.x,f.y,4);

  // 生物更新
  for(let i=organisms.length-1;i>=0;i--){
    let o=organisms[i];
    o.update();
    o.show();
    if(o.dead()){
      organisms.splice(i,1);
      fertility=min(1,fertility+0.001);
    }else{
      let child=o.reproduce();
      if(child) organisms.push(child);
    }
  }
}

/* =====================
   コマンド
===================== */
function runCommand(cmd){
  cmd=cmd.trim().toLowerCase();
  if(cmd==="genesis"){
    for(let i=0;i<8;i++)
      organisms.push(new Organism(random(width),random(height)));
  }
  if(cmd==="evolve"){
    organisms.forEach(o=>{
      o.dna.speed=constrain(o.dna.speed+random(-0.5,0.5),0.5,5);
      o.dna.size=constrain(o.dna.size+random(-1,1),5,25);
    });
  }
  if(cmd==="meteor"){
    organisms=organisms.slice(0,floor(organisms.length/2));
    fertility=0.2;
    log("☄ METEOR IMPACT");
  }
  if(cmd==="reset"){
    organisms=[];foods=[];fertility=1;epoch=0;civilization=0;
    spawnFood(200);
  }
}

/* =====================
   生物クラス
===================== */
class Organism{
  constructor(x,y,dna){
    this.pos=createVector(x,y);
    this.vel=p5.Vector.random2D();
    this.acc=createVector();

    // DNA（色遺伝含む）
    this.dna=dna||{
      size:random(8,15),
      speed:random(1.5,3),
      sense:random(50,90),
      hue:random(360)
    };

    this.health=1;
    this.age=0;
    this.maxAge=random(800,1200);
  }

  update(){
    this.age++;

    // 文明別行動
    if(civilization===2){
      let center=createVector(width/2,height/2);
      this.applyForce(this.seek(center).mult(0.3));
    }else{
      this.forage();
    }

    this.vel.add(this.acc);
    this.vel.limit(this.dna.speed);
    this.pos.add(this.vel);
    this.acc.mult(0);

    this.health-=0.003*pow(this.dna.size,0.75);
    this.edges();
  }

  forage(){
    let nearest=null;
    let dmin=this.dna.sense;
    for(let i=foods.length-1;i>=0;i--){
      let d=p5.Vector.dist(this.pos,foods[i]);
      if(d<dmin){
        dmin=d;
        nearest=foods[i];
        if(d<this.dna.size){
          foods.splice(i,1);
          this.health+=0.3;
          fertility-=0.0005;
        }
      }
    }
    if(nearest) this.applyForce(this.seek(nearest));
    else this.wander();
  }

  wander(){
    let a=noise(this.pos.x*0.01,this.pos.y*0.01,time*0.01)*TWO_PI*2;
    this.applyForce(p5.Vector.fromAngle(a).mult(0.2));
  }

  reproduce(){
    if(this.health>1.2 && random()<0.004){
      this.health/=2;
      let childDNA={
        size:this.dna.size+random(-1,1),
        speed:this.dna.speed+random(-0.3,0.3),
        sense:this.dna.sense+random(-10,10),
        hue:(this.dna.hue+random(-10,10)+360)%360
      };
      log(`Mutation → size:${childDNA.size.toFixed(1)} speed:${childDNA.speed.toFixed(1)}`);
      return new Organism(this.pos.x,this.pos.y,childDNA);
    }
    return null;
  }

  dead(){ return this.health<=0||this.age>this.maxAge; }

  seek(t){
    let d=p5.Vector.sub(t,this.pos);
    d.setMag(this.dna.speed);
    return p5.Vector.sub(d,this.vel).limit(0.1);
  }

  applyForce(f){ this.acc.add(f); }

  edges(){
    if(this.pos.x<0) this.pos.x=width;
    if(this.pos.x>width) this.pos.x=0;
    if(this.pos.y<0) this.pos.y=height;
    if(this.pos.y>height) this.pos.y=0;
  }

  show(){
    colorMode(HSB,360,100,100,100);
    let pulse=sin(time*0.1+this.pos.x)*2;
    let c=color(this.dna.hue,80,100,80);

    push();
    translate(this.pos.x,this.pos.y);
    rotate(this.vel.heading()+PI/2);
    noStroke();
    fill(c);
    beginShape();
    vertex(0,-this.dna.size*1.5-pulse);
    bezierVertex(-this.dna.size,0,-this.dna.size,this.dna.size,0,this.dna.size);
    bezierVertex(this.dna.size,this.dna.size,this.dna.size,0,0,-this.dna.size*1.5);
    endShape();
    pop();

    colorMode(RGB,255);
  }
}

/* =====================
   補助
===================== */
function spawnFood(n){
  for(let i=0;i<n;i++)
    foods.push(createVector(random(width),random(height)));
}
function log(t){
  let l=document.getElementById("log");
  l.innerHTML=`${t}<br>`+l.innerHTML;
}
function windowResized(){
  resizeCanvas(windowWidth,windowHeight);
}
</script>
</body>
</html>


