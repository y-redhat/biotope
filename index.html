<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>NovaNotions ‚Äì Ideology Civilization Biotope</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<style>
body{margin:0;background:#000;font-family:monospace;overflow:hidden}
#ui{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);width:90%;text-align:center;z-index:10}
input{width:60%;padding:10px;background:rgba(0,0,0,.8);border:1px solid #0f0;color:#0f0}
#stats{color:#aaa;font-size:12px;margin-bottom:4px}
#log{position:absolute;top:10px;left:10px;width:320px;height:220px;overflow:auto;
font-size:11px;color:#0f0;background:rgba(0,0,0,.6);border:1px solid #033;padding:5px}
</style>
</head>

<body>
<div id="log"></div>
<div id="ui">
<div id="stats">
YEAR:<span id="year">0</span> |
POP:<span id="pop">0</span> |
CIV:<span id="civ">Hunter-Gatherer</span> |
WAR:<span id="warstat">NO</span>
</div>
<input id="cmd" placeholder="> genesis / evolve / war / meteor / reset">
</div>

<script>
/* =====================
   „Ç∞„É≠„Éº„Éê„É´
===================== */
let organisms=[],foods=[],time=0,epoch=0;
let fertility=1,civilization=0,war=false;
const CIV_NAMES=["Hunter-Gatherer","Agriculture","Nation"];

const FOOD_TYPES={
 plant:{color:[100,255,100],energy:0.25},
 meat:{color:[255,80,80],energy:0.6},
 farm:{color:[180,255,120],energy:0.4}
};

/* ÊÄùÊÉ≥ */
const IDEOLOGY={
 red:{name:"Communism",xMin:0},
 blue:{name:"Capitalism",xMin:0}
};

function setup(){
 createCanvas(windowWidth,windowHeight);
 spawnFood(200);
 runCommand("genesis");

 cmd.addEventListener("keydown",e=>{
  if(e.key==="Enter"){runCommand(cmd.value);cmd.value="";}
 });
}

/* =====================
   „É°„Ç§„É≥
===================== */
function draw(){
 time++; if(time%60===0) epoch++;
 background(0,30*fertility,10);

 // ÊñáÊòéÈÄ≤Âåñ
 if(organisms.length>40 && civilization===0) civilization=1;
 if(organisms.length>120 && civilization===1) civilization=2;

 // UI
 year.innerText=epoch;
 pop.innerText=organisms.length;
 civ.innerText=CIV_NAMES[civilization];
 warstat.innerText=war?"YES":"NO";

 // È£üÊñôÁîüÊàê
 if(random()<0.12*fertility){
  let type="plant";
  if(civilization>=1 && random()<0.3) type="farm";
  foods.push({pos:createVector(random(width),random(height)),type});
 }

 // È£üÊñôÊèèÁîª
 noStroke();
 for(let f of foods){
  let c=FOOD_TYPES[f.type].color;
  fill(c[0],c[1],c[2],140);
  circle(f.pos.x,f.pos.y,4);
 }

 // ÂÄã‰ΩìÊõ¥Êñ∞
 let red=0,blue=0;
 for(let i=organisms.length-1;i>=0;i--){
  let o=organisms[i];
  o.update();
  o.show();
  if(o.dead()){
   if(random()<0.5) foods.push({pos:o.pos.copy(),type:"meat"});
   organisms.splice(i,1);
   fertility=min(1,fertility+0.001);
  }else{
   if(o.ideology==="red") red++; else blue++;
   let child=o.reproduce();
   if(child) organisms.push(child);
  }
 }

 // Êà¶‰∫âÊù°‰ª∂
 if(!war && organisms.length>100) startWar();
 if(war){
  if(red<=10 && blue>10) endWar("red");
  if(blue<=10 && red>10) endWar("blue");
 }
}

/* =====================
   „Ç≥„Éû„É≥„Éâ
===================== */
function runCommand(cmd){
 cmd=cmd.toLowerCase();
 if(cmd==="genesis"){
  for(let i=0;i<10;i++){
   organisms.push(new Organism(random(width),random(height)));
  }
 }
 if(cmd==="evolve"){
  organisms.forEach(o=>{
   o.dna.speed=constrain(o.dna.speed+random(-0.3,0.3),0.5,3);
  });
 }
 if(cmd==="meteor"){
  organisms=organisms.slice(0,floor(organisms.length/2));
  fertility=0.2;
  log("‚òÑ METEOR IMPACT");
 }
 if(cmd==="war") startWar();
 if(cmd==="reset") location.reload();
}

/* =====================
   ÁîüÁâ©
===================== */
class Organism{
 constructor(x,y,dna){
  this.pos=createVector(x,y);
  this.vel=p5.Vector.random2D();
  this.acc=createVector();

  this.ideology=random()<0.5?"red":"blue";
  if(this.ideology==="red") this.pos.x=random(width/2);
  else this.pos.x=random(width/2,width);

  this.dna=dna||{
   size:random(8,15),
   speed:random(0.6,1.4),
   sense:random(50,90),
   hue:random(360)
  };

  this.diet=random(["herbivore","carnivore","omnivore"]);
  this.memory={good:0,bad:0};

  this.health=1;
  this.age=0;
  this.maxAge=random(900,1400);
 }

 update(){
  this.age++;
  if(this.health<=0||this.age>this.maxAge) this.health=0;

  if(civilization===2){
   let cx=this.ideology==="red"?width*0.25:width*0.75;
   this.applyForce(this.seek(createVector(cx,height/2)).mult(0.2));
  }else this.forage();

  this.vel.add(this.acc);
  this.vel.limit(this.dna.speed*(war?1.3:1));
  this.pos.add(this.vel);
  this.acc.mult(0);

  this.health-=0.002*pow(this.dna.size,0.75);
  this.edges();

  if(war){
   organisms.forEach(o=>{
    if(o.ideology!==this.ideology && dist(this.pos.x,this.pos.y,o.pos.x,o.pos.y)<6){
     if(random()<0.01) this.health=0;
    }
   });
  }
 }

 forage(){
  let nearest=null,dmin=this.dna.sense;
  for(let i=foods.length-1;i>=0;i--){
   let d=p5.Vector.dist(this.pos,foods[i].pos);
   if(d<dmin){
    dmin=d; nearest=foods[i];
    if(d<this.dna.size){
     let gain=FOOD_TYPES[foods[i].type].energy;
     if(this.diet==="herbivore"&&foods[i].type==="meat") gain*=0.2;
     if(this.diet==="carnivore"&&foods[i].type!=="meat") gain*=0.2;
     this.health+=gain;
     this.memory.good++;
     foods.splice(i,1);
    }
   }
  }
  if(nearest) this.applyForce(this.seek(nearest.pos));
  else this.wander();
 }

 wander(){
  let a=noise(this.pos.x*0.01,this.pos.y*0.01,time*0.01)*TWO_PI*2;
  this.applyForce(p5.Vector.fromAngle(a).mult(0.08));
 }

 reproduce(){
  if(this.health>1.2 && random()<0.003){
   this.health/=2;
   let childDNA={
    size:this.dna.size+random(-1,1),
    speed:this.dna.speed+random(-0.2,0.2),
    sense:this.dna.sense+random(-10,10)
      +this.memory.good*0.4-this.memory.bad*0.3,
    hue:(this.dna.hue+random(-10,10)+360)%360
   };
   log("Birth + Mutation");
   return new Organism(this.pos.x,this.pos.y,childDNA);
  }
  return null;
 }

 dead(){return this.health<=0;}

 seek(t){
  let d=p5.Vector.sub(t,this.pos);
  d.setMag(this.dna.speed);
  return p5.Vector.sub(d,this.vel).limit(0.1);
 }

 applyForce(f){this.acc.add(f);}
 edges(){
  if(this.ideology==="red") this.pos.x=constrain(this.pos.x,0,width/2);
  else this.pos.x=constrain(this.pos.x,width/2,width);
  this.pos.y=constrain(this.pos.y,0,height);
 }
 show(){
  colorMode(HSB,360,100,100,100);
  fill(this.dna.hue,80,100,80);
  noStroke();
  ellipse(this.pos.x,this.pos.y,this.dna.size*0.7);
  colorMode(RGB,255);
 }
}

/* =====================
   Êà¶‰∫â
===================== */
function startWar(){
 if(civilization<2) return;
 war=true;
 log("‚öî WAR STARTED");
}
function endWar(loser){
 war=false;
 log("üè≥ "+loser+" surrendered");
}

/* =====================
   Ë£úÂä©
===================== */
function spawnFood(n){
 for(let i=0;i<n;i++)
  foods.push({pos:createVector(random(width),random(height)),type:"plant"});
}
function log(t){
 let l=document.getElementById("log");
 l.innerHTML=t+"<br>"+l.innerHTML;
}
function windowResized(){resizeCanvas(windowWidth,windowHeight);}
</script>
</body>
</html>
