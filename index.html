<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Ideology Biotope</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<style>
body{margin:0;background:#000;font-family:monospace;overflow:hidden}
#ui{
 position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
 width:80%;text-align:center;z-index:10
}
input{
 width:60%;padding:10px;background:#000;color:#0f0;
 border:1px solid #0f0;font-size:14px
}
#stats{color:#aaa;font-size:12px;margin-bottom:4px}
</style>
</head>

<body>
<div id="ui">
<div id="stats"></div>
<input id="cmd" placeholder="> war / reset">
</div>

<script>
/* ================================
   基本設定
================================ */
const GRID = 30;
const COLS = 30;
const ROWS = 18;
let territory = [];
let people = [];
let war = false;

/* 思想パラメータ（公平） */
const IDEOLOGY = {
 red:{color:[255,80,80], birth:0.008, move:0.6},
 blue:{color:[80,150,255], birth:0.008, move:0.6}
};

/* ================================
   初期化
================================ */
function setup(){
 createCanvas(COLS*GRID,ROWS*GRID);
 for(let i=0;i<COLS*ROWS;i++){
  territory[i]=random()<0.5?"red":"blue";
 }
 for(let i=0;i<40;i++) spawn();
}

/* ================================
   メインループ
================================ */
function draw(){
 background(0);
 drawTerritory();

 let r=0,b=0;

 for(let i=people.length-1;i>=0;i--){
  let p=people[i];
  p.update();
  p.draw();
  if(p.dead) people.splice(i,1);
  else p.side==="red"?r++:b++;
 }

 /* 自動戦争 */
 if(!war && people.length>100) war=true;

 /* 降伏判定 */
 if(war){
  if(r<=10 && b>10) surrender("red");
  if(b<=10 && r>10) surrender("blue");
 }

 /* 繁殖（控えめ） */
 if(people.length<120){
  people.forEach(p=>{
   if(random()<IDEOLOGY[p.side].birth) spawn(p.side,p.x,p.y);
  });
 }

 document.getElementById("stats").innerText =
  `POP:${people.length} RED:${r} BLUE:${b} WAR:${war}`;
}

/* ================================
   領土描画
================================ */
function drawTerritory(){
 stroke(40);
 for(let y=0;y<ROWS;y++){
  for(let x=0;x<COLS;x++){
   let id=territory[y*COLS+x];
   fill(id==="red"?255:80, id==="red"?120:180, id==="red"?120:255,80);
   rect(x*GRID,y*GRID,GRID,GRID);
  }
 }
}

/* ================================
   個体
================================ */
class Person{
 constructor(x,y,side){
  this.x=x;this.y=y;
  this.vx=random(-1,1);this.vy=random(-1,1);
  this.side=side;
  this.life=1000;
  this.dead=false;
 }
 update(){
  this.life--;
  if(this.life<0) this.dead=true;

  let m=IDEOLOGY[this.side].move*(war?1.8:1);
  this.x+=this.vx*m;
  this.y+=this.vy*m;

  this.vx+=random(-0.3,0.3);
  this.vy+=random(-0.3,0.3);

  this.x=constrain(this.x,0,width);
  this.y=constrain(this.y,0,height);

  /* 戦争ダメージ */
  if(war){
   people.forEach(o=>{
    if(o.side!==this.side && dist(this.x,this.y,o.x,o.y)<6){
     if(random()<0.02) this.dead=true;
    }
   });
  }
 }
 draw(){
  noStroke();
  let c=IDEOLOGY[this.side].color;
  fill(c[0],c[1],c[2]);
  ellipse(this.x,this.y,5,5);
 }
}

/* ================================
   生成
================================ */
function spawn(side,x,y){
 let s=side||random()<0.5?"red":"blue";
 let px=x||random(width);
 let py=y||random(height);
 people.push(new Person(px,py,s));
}

/* ================================
   戦争終了（降伏）
================================ */
function surrender(loser){
 war=false;
 let win=loser==="red"?"blue":"red";

 IDEOLOGY[win].birth*=1.1;
 IDEOLOGY[win].move*=1.05;

 for(let i=0;i<territory.length;i++){
  if(territory[i]===loser && random()<0.6)
   territory[i]=win;
 }
}

/* ================================
   コマンド
================================ */
document.getElementById("cmd").addEventListener("keydown",e=>{
 if(e.key==="Enter"){
  if(e.target.value==="war") war=true;
  if(e.target.value==="reset") location.reload();
  e.target.value="";
 }
});
</script>
</body>
</html>
